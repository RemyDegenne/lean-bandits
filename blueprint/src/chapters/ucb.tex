\section{UCB}

TODO: update this chapter to reflect the changes in the formalization.

\begin{definition}[UCB algorithm]\label{def:ucbAlgorithm}
  \uses{def:IT.actionReward, def:pullCount, def:empMean}
  \leanok
  \lean{Bandits.UCB.nextArm, Bandits.ucbAlgorithm}
The UCB algorithm with parameter $c \in \mathbb{R}_+$ is defined as follows:
\begin{enumerate}
  \item for $t < K$, $A_t = t \mod K$ (pull each arm once),
  \item for $t \ge K$, $A_t = \arg\max_{a \in [K]} \left( \hat{\mu}_{t,a} + \sqrt{\frac{c \log(t + 1)}{N_{t,a}}} \right)$, where $\hat{\mu}_{t,a} = \frac{1}{N_{t,a}} \sum_{s=0}^{t-1} \mathbb{I}(A_s = a) X_s$ is the empirical mean of the rewards for arm $a$.
\end{enumerate}
\end{definition}

Note: the argmax in the second step is chosen in a measurable way.


\begin{lemma}\label{lem:ucbIndex_le_ucbIndex_arm}
  \uses{def:ucbAlgorithm}
  \leanok
  \lean{Bandits.UCB.ucbIndex_le_ucbIndex_arm}
For the UCB algorithm, for all time $t \ge K$ and arm $a \in [K]$, we have
\begin{align*}
  \hat{\mu}_{t,a} + \sqrt{\frac{c \log(t + 1)}{N_{t,a}}}
  &\le \hat{\mu}_{t,A_t} + \sqrt{\frac{c \log(t + 1)}{N_{t,A_t}}}
  \: .
\end{align*}
\end{lemma}

\begin{proof}\leanok
By definition of the algorithm.
\end{proof}


\begin{lemma}\label{lem:gap_arm_le_two_mul_ucbWidth}
  \uses{def:ucbAlgorithm}
  \leanok
  \lean{Bandits.UCB.gap_arm_le_two_mul_ucbWidth, Bandits.UCB.pullCount_arm_le}
Suppose that we have the 3 following conditions:
\begin{enumerate}
  \item $\mu^* \le \hat{\mu}_{t, a^*} + \sqrt{\frac{c \log(t + 1)}{N_{t,a^*}}}$,
  \item $\hat{\mu}_{t,A_t} - \sqrt{\frac{c \log(t + 1)}{N_{t,A_t}}} \le \mu_{A_t}$,
  \item $\hat{\mu}_{t, a^*} + \sqrt{\frac{c \log(t + 1)}{N_{t,a^*}}} \le \hat{\mu}_{t,A_t} + \sqrt{\frac{c \log(t + 1)}{N_{t,A_t}}}$.
\end{enumerate}
Then if $N_{t,A_t} > 0$ we have
\begin{align*}
  \Delta_{A_t}
  &\le 2 \sqrt{\frac{c \log(t + 1)}{N_{t,A_t}}}
  \: .
\end{align*}
And in turn, if $\Delta_{A_t} > 0$ we get
\begin{align*}
  N_{t,A_t}
  &\le \frac{4 c \log(t + 1)}{\Delta_{A_t}^2}
  \: .
\end{align*}

Note that the third condition is always satisfied for UCB by Lemma~\ref{lem:ucbIndex_le_ucbIndex_arm}, but this lemma, as stated, is independent of the UCB algorithm.
\end{lemma}

\begin{proof}\leanok

\end{proof}


%todo: move to concentration section?
\begin{lemma}\label{lem:todo}
  \uses{def:rewardByCount}
  \leanok
  \lean{Bandits.UCB.todo, Bandits.UCB.todo'}
Suppose that $\nu(a)$ is 1-sub-Gaussian for all arms $a \in [K]$.
Let $c \ge 0$ be a real number and $k$ a positive natural number.
Then
\begin{align*}
  P\left(\frac{1}{k} \sum_{m=1}^k Y_{m, a} + \sqrt{\frac{c \log(n + 1)}{k}} \le \mu_a\right)
  &\le \frac{1}{(n + 1)^{c / 2}}
  \: .
\end{align*}
And also,
\begin{align*}
  P\left(\frac{1}{k} \sum_{m=1}^k Y_{m, a} - \sqrt{\frac{c \log(n + 1)}{k}} \ge \mu_a\right)
  &\le \frac{1}{(n + 1)^{c / 2}}
  \: .
\end{align*}
\end{lemma}

\begin{proof}\leanok
  \uses{lem:identDistrib_sum_Icc_rewardByCount, thm:hoeffding}

\end{proof}


\begin{lemma}\label{lem:prob_ucbIndex_le}
  \uses{def:empMean, def:pullCount}
  \leanok
  \lean{Bandits.UCB.prob_ucbIndex_le, Bandits.UCB.prob_ucbIndex_ge}
Suppose that $\nu(a)$ is 1-sub-Gaussian for all arms $a \in [K]$.
Let $c \ge 0$ be a real number.
Then for any time $n \in \mathbb{N}$ and any arm $a \in [K]$, we have
\begin{align*}
  P\left(0 < N_{n, a} \ \wedge \ \hat{\mu}_{n, a} + \sqrt{\frac{c \log(n + 1)}{N_{n,a}}} \le \mu_a\right)
  &\le \frac{1}{(n + 1)^{c / 2 - 1}}
  \: .
\end{align*}
And also,
\begin{align*}
  P\left(0 < N_{n, a} \ \wedge \ \hat{\mu}_{n, a} - \sqrt{\frac{c \log(n + 1)}{N_{n,a}}} \ge \mu_a\right)
  &\le \frac{1}{(n + 1)^{c / 2 - 1}}
  \: .
\end{align*}
\end{lemma}

\begin{proof}\leanok
  \uses{lem:todo, lem:pullCount_basic}
Since $N_{n,a} \le n$ (Lemma~\ref{lem:pullCount_basic}), there exists $k \in [1, n]$ such that $N_{n,a} = k$ and $\hat{\mu}_{n,a} = \frac{1}{k} \sum_{m=1}^k Y_{m,a}$.

Then apply a union bound over $k \in [1, n]$ and use Lemma~\ref{lem:todo}.
\end{proof}


\begin{lemma}\label{lem:pullCount_le_add_three}
  \uses{def:pullCount, def:empMean}
  \leanok
  \lean{Bandits.UCB.pullCount_le_add_three, Bandits.UCB.pullCount_le_add_three_ae}
For $C$ a natural number, for any time $n \in \mathbb{N}$ and any arm $a \in [K]$, we have
\begin{align*}
  N_{n,a}
  &\le C + 1
  \\&\quad +
      \sum_{s=1}^{n-1} \mathbb{I}\{A_s = a \ \wedge \ C < N_{s,a} \ \wedge \
        \mu^* \le \hat{\mu}_{s, a^*} + \sqrt{\frac{c \log(s + 1)}{N_{s,a^*}}} \ \wedge \
        \hat{\mu}_{s, A_s} - \sqrt{\frac{c \log(s + 1)}{N_{s,A_s}}} \le \mu_{A_s}\}
  \\&\quad +
      \sum_{s=1}^{n-1}
        \mathbb{I}\{0 < N_{s, a^*} \ \wedge \ \hat{\mu}_{s, a^*} + \sqrt{\frac{c \log(s + 1)}{N_{s,a^*}}} <
          \mu^*\}
  \\&\quad +
      \sum_{s=1}^{n-1}
        \mathbb{I}\{0 < N_{s, a} \ \wedge \ \mu_a <
          \hat{\mu}_{s, a} - \sqrt{\frac{c \log(s + 1)}{N_{s,a}}}\}
\end{align*}
\end{lemma}

\begin{proof}\leanok

\end{proof}


\begin{lemma}\label{lem:some_sum_eq_zero}
  \uses{def:pullCount, def:empMean, def:ucbAlgorithm}
  \leanok
  \lean{Bandits.UCB.some_sum_eq_zero}
For the UCB algorithm with parameter $c \ge 0$, for any time $n \in \mathbb{N}$ and any arm $a \in [K]$ with positive gap, the first sum in Lemma~\ref{lem:pullCount_le_add_three} is equal to zero for positive $C$ such that $C \ge \frac{4 c \log(n + 1)}{\Delta_a^2}$.
\end{lemma}

\begin{proof}\leanok
  \uses{lem:gap_arm_le_two_mul_ucbWidth, lem:ucbIndex_le_ucbIndex_arm}

\end{proof}


\begin{lemma}\label{lem:expectation_pullCount_le}
  \uses{def:ucbAlgorithm, def:pullCount, def:empMean}
  \leanok
  \lean{Bandits.UCB.expectation_pullCount_le}
Suppose that $\nu(a)$ is 1-sub-Gaussian for all arms $a \in [K]$.
For the UCB algorithm with parameter $c > 0$, for any time $n \in \mathbb{N}$ and any arm $a \in [K]$ with positive gap, we have
\begin{align*}
  \mathbb{E}[N_{n,a}]
  &\le \frac{4 c \log(n + 1)}{\Delta_a^2} + 2 + 2 \sum_{s=0}^{n-1} \frac{1}{(s + 1)^{c / 2 - 1}}
  \: .
\end{align*}
\end{lemma}

\begin{proof}\leanok
  \uses{lem:pullCount_le_add_three, lem:some_sum_eq_zero, lem:prob_ucbIndex_le}

\end{proof}


\begin{lemma}\label{lem:ucb_regret_le}
  \uses{def:ucbAlgorithm, def:regret}
  \leanok
  \lean{Bandits.UCB.regret_le}
Suppose that $\nu(a)$ is 1-sub-Gaussian for all arms $a \in [K]$.
For the UCB algorithm with parameter $c > 0$, for any time $n \in \mathbb{N}$, we have
\begin{align*}
  R_n
  &\le \sum_{a : \Delta_a > 0} \left(\frac{4 c \log(n + 1)}{\Delta_a} + 2 \Delta_a\left(1 + \sum_{s=0}^{n-1} \frac{1}{(s + 1)^{c / 2 - 1}}\right)\right)
  \: .
\end{align*}
\end{lemma}

\begin{proof}\leanok
  \uses{lem:expectation_pullCount_le, lem:regret_eq_sum_pullCount_mul_gap}

\end{proof}

TODO: for $c > 4$, the sum converges to a constant, so we get a logarithmic regret bound.
