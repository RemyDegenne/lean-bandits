\section{UCB}

\begin{definition}[UCB algorithm]\label{def:ucbAlgorithm}
  \uses{def:detAlgorithm,def:algorithm}
  \leanok
  \lean{Bandits.UCB.nextArm, Bandits.ucbAlgorithm}
The UCB algorithm with parameter $c \in \mathbb{R}_+$ is defined as follows:
\begin{enumerate}
  \item for $t < K$, $A_t = t \mod K$ (pull each arm once),
  \item for $t \ge K$, $A_t = \arg\max_{a \in [K]} \left( \hat{\mu}_{t,a} + \sqrt{\frac{2 c \log(t + 1)}{N_{t,a}}} \right)$, where $\hat{\mu}_{t,a} = \frac{1}{N_{t,a}} \sum_{s=0}^{t-1} \mathbb{I}(A_s = a) X_s$ is the empirical mean of the rewards for arm $a$.
\end{enumerate}
\end{definition}

Note: the argmax in the second step is chosen in a measurable way.


\begin{lemma}\label{lem:UCB.isAlgEnvSeqUntil_roundRobinAlgorithm}
  \uses{def:stationaryEnv,def:IsAlgEnvSeq,def:ucbAlgorithm,def:roundRobinAlgorithm}
  \leanok
  \lean{Bandits.UCB.isAlgEnvSeqUntil_roundRobinAlgorithm}
An algorithm-environment sequence for the UCB algorithm is an algorithm-environment sequence for the Round-Robin algorithm until time $K - 1$.
That is, UCB plays the same as Round-Robin until time $K - 1$.
\end{lemma}

\begin{proof}
  \leanok

\end{proof}


\begin{lemma}\label{lem:ucbIndex_le_ucbIndex_arm}
  \uses{def:stationaryEnv,def:IsAlgEnvSeq,def:ucbAlgorithm,def:pullCount,def:empMean}
  \leanok
  \lean{Bandits.UCB.ucbIndex_le_ucbIndex_arm}
For the UCB algorithm, for all time $t \ge K$ and arm $a \in [K]$, we have
\begin{align*}
  \hat{\mu}_{t,a} + \sqrt{\frac{2 c \log(t + 1)}{N_{t,a}}}
  &\le \hat{\mu}_{t,A_t} + \sqrt{\frac{2 c \log(t + 1)}{N_{t,A_t}}}
  \: .
\end{align*}
\end{lemma}

\begin{proof}\leanok
  \uses{def:environment,def:detAlgorithm,def:algorithm,def:sumRewards,def:ucbAlgorithm,def:history}
By definition of the algorithm.
\end{proof}


\begin{lemma}\label{lem:gap_arm_le_two_mul_ucbWidth}
  \uses{def:pullCount,def:gap,def:empMean,def:pullCount,def:gap,def:empMean}
  \leanok
  \lean{Bandits.UCB.gap_arm_le_two_mul_ucbWidth, Bandits.UCB.pullCount_arm_le}
Suppose that we have the 3 following conditions:
\begin{enumerate}
  \item $\mu^* \le \hat{\mu}_{t, a^*} + \sqrt{\frac{2 c \log(t + 1)}{N_{t,a^*}}}$,
  \item $\hat{\mu}_{t,A_t} - \sqrt{\frac{2 c \log(t + 1)}{N_{t,A_t}}} \le \mu_{A_t}$,
  \item $\hat{\mu}_{t, a^*} + \sqrt{\frac{2 c \log(t + 1)}{N_{t,a^*}}} \le \hat{\mu}_{t,A_t} + \sqrt{\frac{2 c \log(t + 1)}{N_{t,A_t}}}$.
\end{enumerate}
Then if $N_{t,A_t} > 0$ we have
\begin{align*}
  \Delta_{A_t}
  &\le 2 \sqrt{\frac{2 c \log(t + 1)}{N_{t,A_t}}}
  \: .
\end{align*}
And in turn, if $\Delta_{A_t} > 0$ we get
\begin{align*}
  N_{t,A_t}
  &\le \frac{8 c \log(t + 1)}{\Delta_{A_t}^2}
  \: .
\end{align*}

Note that the third condition is always satisfied for UCB by Lemma~\ref{lem:ucbIndex_le_ucbIndex_arm}, but this lemma, as stated, is independent of the UCB algorithm.
\end{lemma}

\begin{proof}\leanok

\end{proof}


\begin{lemma}\label{lem:prob_ucbIndex_le}
  \uses{def:stationaryEnv,def:IsAlgEnvSeq,def:subGaussian,def:ucbAlgorithm,def:pullCount,def:empMean}
  \leanok
  \lean{Bandits.UCB.prob_ucbIndex_le, Bandits.UCB.prob_ucbIndex_ge}
Suppose that $\nu(a)$ is $\sigma^2$-sub-Gaussian for all arms $a \in [K]$.
Let $c \ge 0$ be a real number.
Then for any time $n \in \mathbb{N}$ and any arm $a \in [K]$, we have
\begin{align*}
  P\left(0 < N_{n, a} \ \wedge \ \hat{\mu}_{n, a} + \sqrt{\frac{2 c \sigma^2 \log(n + 1)}{N_{n,a}}} \le \mu_a\right)
  &\le \frac{1}{(n + 1)^{c - 1}}
  \: .
\end{align*}
And also,
\begin{align*}
  P\left(0 < N_{n, a} \ \wedge \ \hat{\mu}_{n, a} - \sqrt{\frac{2 c \sigma^2 \log(n + 1)}{N_{n,a}}} \ge \mu_a\right)
  &\le \frac{1}{(n + 1)^{c - 1}}
  \: .
\end{align*}
\end{lemma}

\begin{proof}\leanok
  \uses{lem:prob_sum_le_sqrt_log,thm:ionescu-tulcea,lem:prob_pullCount_prod_sumRewards_mem_le}

\end{proof}


\begin{lemma}\label{lem:pullCount_le_add_three}
  \uses{def:pullCount,def:empMean,def:stationaryEnv,def:IsAlgEnvSeq,def:ucbAlgorithm}
  \leanok
  \lean{Bandits.UCB.pullCount_le_add_three, Bandits.UCB.pullCount_le_add_three_ae}
For $C$ a natural number, for any time $n \in \mathbb{N}$ and any arm $a \in [K]$, we have
\begin{align*}
  N_{n,a}
  &\le C + 1
  \\&\quad +
      \sum_{s=1}^{n-1} \mathbb{I}\{A_s = a \ \wedge \ C < N_{s,a} \ \wedge \
        \mu^* \le \hat{\mu}_{s, a^*} + \sqrt{\frac{2 c \sigma^2 \log(s + 1)}{N_{s,a^*}}} \ \wedge \
        \hat{\mu}_{s, A_s} - \sqrt{\frac{2 c \sigma^2 \log(s + 1)}{N_{s,A_s}}} \le \mu_{A_s}\}
  \\&\quad +
      \sum_{s=1}^{n-1}
        \mathbb{I}\{0 < N_{s, a^*} \ \wedge \ \hat{\mu}_{s, a^*} + \sqrt{\frac{2 c \sigma^2 \log(s + 1)}{N_{s,a^*}}} <
          \mu^*\}
  \\&\quad +
      \sum_{s=1}^{n-1}
        \mathbb{I}\{0 < N_{s, a} \ \wedge \ \mu_a <
          \hat{\mu}_{s, a} - \sqrt{\frac{2 c \sigma^2 \log(s + 1)}{N_{s,a}}}\}
\end{align*}
\end{lemma}

\begin{proof}\leanok
  \uses{def:environment,def:detAlgorithm,def:algorithm,def:ucbAlgorithm,def:history,lem:pullCount_basic}

\end{proof}


\begin{lemma}\label{lem:some_sum_eq_zero}
  \uses{def:stationaryEnv,def:IsAlgEnvSeq,def:ucbAlgorithm,def:pullCount,def:gap,def:empMean}
  \leanok
  \lean{Bandits.UCB.some_sum_eq_zero}
For the UCB algorithm with parameter $c \sigma^2 \ge 0$, for any time $n \in \mathbb{N}$ and any arm $a \in [K]$ with positive gap, the first sum in Lemma~\ref{lem:pullCount_le_add_three} is equal to zero for positive $C$ such that $C \ge \frac{8 c \sigma^2 \log(n + 1)}{\Delta_a^2}$.
\end{lemma}

\begin{proof}\leanok
  \uses{def:environment,def:detAlgorithm,def:algorithm,def:ucbAlgorithm,lem:ucbIndex_le_ucbIndex_arm,def:history,lem:pullCount_basic,lem:gap_arm_le_two_mul_ucbWidth}

\end{proof}


\begin{lemma}\label{lem:expectation_pullCount_le}
  \uses{def:stationaryEnv,def:IsAlgEnvSeq,def:subGaussian,def:ucbAlgorithm,def:pullCount,def:gap}
  \leanok
  \lean{Bandits.UCB.expectation_pullCount_le}
Suppose that $\nu(a)$ is $\sigma^2$-sub-Gaussian for all arms $a \in [K]$.
For the UCB algorithm with parameter $c \sigma^2 > 0$, for any time $n \in \mathbb{N}$ and any arm $a \in [K]$ with positive gap, we have
\begin{align*}
  P[N_{n,a}]
  &\le \frac{8 c \sigma^2 \log(n + 1)}{\Delta_a^2} + 2 + 2 \sum_{s=0}^{n-1} \frac{1}{(s + 1)^{c - 1}}
  \: .
\end{align*}
\end{lemma}

\begin{proof}\leanok
  \uses{def:environment,def:algorithm,def:sumRewards,lem:some_sum_eq_zero,lem:prob_ucbIndex_le,lem:pullCount_basic,def:empMean,lem:pullCount_le_add_three}

\end{proof}


\begin{lemma}\label{lem:ucb_regret_le}
  \uses{def:stationaryEnv,def:regret,def:IsAlgEnvSeq,def:subGaussian,def:ucbAlgorithm,def:gap}
  \leanok
  \lean{Bandits.UCB.regret_le}
Suppose that $\nu(a)$ is $\sigma^2$-sub-Gaussian for all arms $a \in [K]$.
For the UCB algorithm with parameter $c \sigma^2 > 0$, for any time $n \in \mathbb{N}$, we have
\begin{align*}
  P[R_n]
  &\le \sum_{a : \Delta_a > 0} \left(\frac{8 c \sigma^2 \log(n + 1)}{\Delta_a} + 2 \Delta_a\left(1 + \sum_{s=0}^{n-1} \frac{1}{(s + 1)^{c - 1}}\right)\right)
  \: .
\end{align*}
\end{lemma}

\begin{proof}\leanok
  \uses{def:environment,def:algorithm,cor:integral_regret_eq_sum_mul,lem:pullCount_basic,lem:expectation_pullCount_le,def:pullCount}

\end{proof}

TODO: for $c > 2$, the sum converges to a constant, so we get a logarithmic regret bound.
